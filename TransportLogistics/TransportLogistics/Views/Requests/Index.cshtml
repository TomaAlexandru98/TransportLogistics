@model TransportLogistics.ViewModels.Requests.RequestsViewModel
@{
    ViewData["Title"] = "Index";
}

<link rel="stylesheet" type="text/css" href="~/lib/datatables/datatables.min.css" />
<link rel="stylesheet" type="text/css" href="~/lib/datatables/Responsive-2.2.3/css/responsive.bootstrap4.css" />
<link rel="stylesheet" type="text/css" href="~/lib/datatables/Responsive-2.2.3/css/responsive.dataTables.min.css" />

<div id="requestTableContainer"></div>

@Html.AntiForgeryToken()
<div class="modal fade" id="multipleRequestsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Multiple requests</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    Multiple requests were found for this vehicle
                    <input id="requestId" type="hidden" />
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="acceptRequestAnywayButton()" type="button" class="btn btn-secondary" data-dismiss="modal">
                    Accept anyway
                </button>
                <button onclick="showAllRequestsButton()" type="submit" data-dismiss="modal" class="btn btn-primary">
                    Show all
                </button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script type="text/javascript" src="~/lib/datatables/datatables.min.js"></script>
    <script type="text/javascript" src="~/lib/datatables/Responsive-2.2.3/js/dataTables.responsive.min.js"></script>

    <script>
        $(document).ready(function () {
            loadTable();
        });

        function loadTable() {
            loadServerPartialView("#requestTableContainer", "/Requests/RequestsTable").done(function () {
                $('#requestsTable').DataTable({ responsive: true, "lengthMenu": [5, 10, 25, 50] });
            });
        }

        function declineRequest(requestId) {
            $.ajax({
                url: "/Requests/Decline?id=" + requestId,
                success: function (response) {
                    loadTable();
                }
            });
        }

        function checkForMultipleRequests(requestId, trailerId) {
            @foreach (var request in Model.Requests)
            {
                @: if (trailerId == "@request.Trailer.Id" && requestId != "@request.Id") {
                    @: $("#multipleRequestsModal").modal();
                    @: $('#requestId').val(requestId);
                    @: return true;
                @: }
            }

            acceptRequestButton(requestId);
        }

        function acceptRequestButton(requestId) {
            $.ajax({
                url: "/Requests/Accept?id=" + requestId,
                success: function () {
                    loadTable();
                }
            });
        }

        function acceptRequestAnywayButton() {
            var requestId = $("#requestId").val();
            $.ajax({
                url: "/Requests/Accept?id=" + requestId,
                success: function () {
                    loadTable();
                }
            });
        }

        function showAllRequestsButton() {
            var requestId = $("#requestId").val();
            loadServerPartialView("#requestTableContainer", "/Requests/Filter?id=" + requestId).done(function () {
                $('#requestsTable').DataTable({ responsive: true, "lengthMenu": [5, 10, 25, 50] });
            });
        }
    </script>
}